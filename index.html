<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TAMM Life Events Medical Hub</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React + ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

    <script>window.react = window.React;</script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
      .hide-scrollbar::-webkit-scrollbar { display: none; }
      .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      
      @keyframes slideUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }

      @keyframes popIn {
        0% { transform: scale(0.5); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
      }
      .animate-pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo, useEffect, useRef } = React;

      // --- ICON SYSTEM ---
      const Lucide = window.LucideReact || {};
      const FallbackIcon = (props) => <span {...props} className="inline-block w-4 h-4 bg-slate-200" />;
      const getIcon = (name) => Lucide[name] || FallbackIcon;
      
      const Icons = {
        Baby: getIcon("Baby"),
        HeartPulse: getIcon("HeartPulse"),
        ShieldCheck: getIcon("ShieldCheck"),
        School: getIcon("School"),
        Stethoscope: getIcon("Stethoscope"),
        ClipboardCheck: getIcon("ClipboardCheck"),
        FileText: getIcon("FileText"),
        Sparkles: getIcon("Sparkles"),
        UserRound: getIcon("UserRound"),
        Activity: getIcon("Activity"),
        Users: getIcon("Users"),
        Briefcase: getIcon("Briefcase"),
        Home: getIcon("Home"),
        BookOpen: getIcon("BookOpen"),
        ChevronRight: getIcon("ChevronRight"),
        Search: getIcon("Search"),
        Send: getIcon("Send"),
        CheckCircle2: getIcon("CheckCircle2"),
        AlertTriangle: getIcon("AlertTriangle"),
        HeartHandshake: getIcon("HeartHandshake"),
        GraduationCap: getIcon("GraduationCap"),
        Calendar: getIcon("Calendar"),
        MapPin: getIcon("MapPin"),
        Clock: getIcon("Clock"),
        X: getIcon("X"),
        ArrowRight: getIcon("ArrowRight"),
        Building2: getIcon("Building2"),
        Bot: getIcon("Bot"),
        Circle: getIcon("Circle"),
        HandHeart: getIcon("HandHeart"),
        Link2: getIcon("Link2"),
        MessageCircle: getIcon("MessageCircle"),
        User: getIcon("User"),
        Accessibility: getIcon("Accessibility"),
        Plane: getIcon("Plane"),
        Info: getIcon("Info"),
        ChevronDown: getIcon("ChevronDown"),
        List: getIcon("List"),
        Table2: getIcon("Table2"),
        ListTodo: getIcon("ListTodo"),
        Pencil: getIcon("Pencil"), // Replaced Edit3 with Pencil
        Loader2: getIcon("Loader2"),
        Eye: getIcon("Eye"),
        EyeOff: getIcon("EyeOff"),
        Gift: getIcon("Gift"),
        Mail: getIcon("Mail"),
        ArrowLeft: getIcon("ArrowLeft"),
        Settings2: getIcon("Settings2"),
        CheckSquare: getIcon("CheckSquare"),
        Square: getIcon("Square"),
        Wand2: getIcon("Wand2"), // For AI Generate
      };

      // --- UI COMPONENTS ---

      const Card = ({ className, children, onClick }) => (
        <div onClick={onClick} className={`rounded-2xl border border-slate-200 bg-white text-slate-950 shadow-sm ${className || ""} ${onClick ? 'cursor-pointer hover:shadow-md transition-shadow' : ''}`}>{children}</div>
      );
      const CardHeader = ({ className, children }) => <div className={`flex flex-col space-y-1.5 p-6 ${className || ""}`}>{children}</div>;
      const CardTitle = ({ className, children }) => <h3 className={`text-xl font-bold leading-none tracking-tight text-slate-900 ${className || ""}`}>{children}</h3>;
      const CardDescription = ({ className, children }) => <p className={`text-sm text-slate-500 ${className || ""}`}>{children}</p>;
      const CardContent = ({ className, children }) => <div className={`p-6 pt-0 ${className || ""}`}>{children}</div>;

      const Button = ({ className, variant = "default", size = "default", children, ...props }) => {
        const variants = {
          default: "bg-teal-700 text-white hover:bg-teal-800 shadow-md shadow-teal-900/10",
          outline: "border border-slate-200 bg-white hover:bg-slate-50 text-slate-900",
          ghost: "hover:bg-slate-100 text-slate-700",
          secondary: "bg-slate-100 text-slate-900 hover:bg-slate-200",
          purple: "bg-purple-600 text-white hover:bg-purple-700 shadow-md shadow-purple-600/20", // For AI Action
        };
        const sizes = { default: "h-10 px-4 py-2", sm: "h-8 rounded-lg px-3 text-xs", icon: "h-10 w-10" };
        return (
          <button className={`inline-flex items-center justify-center whitespace-nowrap rounded-xl text-sm font-medium transition-all focus:outline-none focus:ring-2 focus:ring-slate-950 ${variants[variant]} ${sizes[size]} ${className || ""}`} {...props}>{children}</button>
        );
      };

      const Badge = ({ className, variant = "default", children }) => {
        const variants = {
          default: "bg-slate-900 text-white",
          secondary: "bg-slate-100 text-slate-900",
          outline: "border border-slate-200 text-slate-600",
          teal: "bg-teal-50 text-teal-700 border border-teal-200",
          amber: "bg-amber-50 text-amber-700 border border-amber-200",
          success: "bg-emerald-50 text-emerald-700 border border-emerald-200",
        };
        return <div className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold ${variants[variant]} ${className || ""}`}>{children}</div>;
      };

      const Progress = ({ value, className }) => (
        <div className={`relative h-3 w-full overflow-hidden rounded-full bg-slate-100 ${className || ''}`}>
          <div className="h-full bg-teal-600 transition-all duration-500 ease-in-out" style={{ width: `${value}%` }} />
        </div>
      );

      const Input = ({ className, ...props }) => (
        <input
          className={`flex h-10 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-teal-700 disabled:cursor-not-allowed disabled:opacity-50 ${className || ''}`}
          {...props}
        />
      );

      // --- DATA FACTORY ---
      // (Kept same as before)
      const getPersonas = (babyName, revealedGender) => ({
        citizen: {
          label: "Citizen family",
          familyName: "Al Nuaimi Family",
          parents: "Omar & Aisha",
          expectedBaby: babyName ? `Baby ${babyName}` : (revealedGender ? `Baby ${revealedGender}` : "Expecting Baby"),
          location: "Abu Dhabi",
          benefitsLabel: "Family Book Path",
          features: ["Mabrouk Ma Yak", "Genome Testing", "School Seat Reserve"]
        },
        resident: {
          label: "Resident family",
          familyName: "Khan Family",
          parents: "Hassan & Mariam",
          expectedBaby: babyName ? `Baby ${babyName}` : (revealedGender ? `Baby ${revealedGender}` : "Expecting Baby"),
          location: "Abu Dhabi",
          benefitsLabel: "Resident Path",
          features: ["MOFA Attestation", "Embassy Passport", "Civil Marriage"]
        }
      });

      const getJourneyData = (persona, babyName, revealedGender) => {
        const isCitizen = persona === 'citizen';
        
        // Dynamic Birth Journey
        const birthJourney = isCitizen ? {
          title: "Mabrouk Ma Yak",
          subtitle: "Newborn Bundle",
          icon: "Baby",
          description: "One request to issue all your newborn's official documents: Birth Certificate, ID, Passport, and Family Book.",
          status: "Action Required",
          // Simple View Data
          steps: [
            { title: "Notification", desc: "Hospital submits birth details.", status: "completed" },
            { 
              title: "Photo & Name", 
              desc: babyName ? `Named: ${babyName}` : "Baby photo captured. Choose name.", 
              status: babyName ? "completed" : "current",
              actionLabel: "Start Naming" 
            },
            { title: "Bundle Processing", desc: "We issue Birth Certificate, EID, and Passport together.", status: babyName ? "current" : "upcoming" },
            { title: "Delivery", desc: "Digital docs in Wallet. Physical cards delivered.", status: "upcoming" }
          ],
          // Detailed Master View Data
          details: [
            { stage: "Trigger", touchpoint: "Birth Certificate Issued", channel: "TAMM Platform", entity: "DoH -> ICP", enhancement: "Auto-trigger bundle" },
            { stage: "Identity", touchpoint: "Issue ID & Passport", channel: "Backend", entity: "ICP", enhancement: "Zero visits required" },
            { stage: "Registry", touchpoint: "Update Family Book", channel: "Backend", entity: "ICP", enhancement: "Real-time sync" },
            { stage: "Delivery", touchpoint: "Wallet Push", channel: "TAMM Wallet", entity: "ICP/TAMM", enhancement: "Instant digital access" }
          ]
        } : {
          title: "Birth & Residency",
          subtitle: "Certificate & Visa",
          icon: "FileText",
          description: "Issue the Birth Certificate, attest it, and proceed with Residency issuance.",
          status: "Action Required",
          steps: [
            { title: "Notification", desc: "Hospital submits birth details.", status: "completed" },
            { 
              title: "Birth Certificate", 
              desc: babyName ? `Certificate for ${babyName}` : "Review details and name baby.", 
              status: babyName ? "completed" : "current",
              actionLabel: "Issue Certificate" 
            },
            { title: "Attestation", desc: "Digital MOFA attestation (if needed).", status: babyName ? "current" : "upcoming" },
            { title: "Residency", desc: "Apply for Passport (Embassy) then Residency (ICP).", status: "upcoming" }
          ],
          details: [
            { stage: "Civil Docs", touchpoint: "Birth Certificate", channel: "TAMM Family Space", entity: "DoH", enhancement: "Digital Issuance" },
            { stage: "Attest", touchpoint: "MOFA Attestation", channel: "TAMM Family Space", entity: "MOFA", enhancement: "One-click digital attest" },
            { stage: "Passport", touchpoint: "Embassy Application", channel: "Embassy/Consulate", entity: "Foreign Mission", enhancement: "Guidance checklist" },
            { stage: "Visa", touchpoint: "Residency & ID", channel: "TAMM/ICP App", entity: "ICP", enhancement: "Linked to sponsor" }
          ]
        };

        return {
          premarital: {
            title: "Premarital Screening",
            subtitle: "Health readiness & Genetics",
            icon: "HeartHandshake",
            description: "Complete your screening to ensure a healthy future family. Results are valid for 3 months.",
            status: "Completed",
            steps: [
              { title: "Check Requirements", desc: "View the checklist for citizens vs residents.", status: "completed" },
              { title: "Book Appointment", desc: "Choose a SEHA facility near you.", status: "completed" },
              { title: "Attend Screening", desc: `Complete lab tests${isCitizen ? " (Genome included)." : "."}`, status: "completed" },
              { title: "Receive Results", desc: "Your certificate will be issued digitally.", status: "completed" },
              { title: "Marriage Readiness", desc: "Your status will automatically update for ADJD.", status: "completed" }
            ],
            details: [
              { stage: "Discovery", touchpoint: "Check requirements", channel: "TAMM Family Space", entity: "DCD + ADJD", enhancement: "Citizen vs Resident rules" },
              { stage: "Booking", touchpoint: "Book appointment", channel: "TAMM Sahatna", entity: "DoH + SEHA", enhancement: "Smart slot suggestion" },
              { stage: "Visit", touchpoint: "Attend screening", channel: "Clinic", entity: "SEHA / ADPHC", enhancement: "Fast-track queue" },
              { stage: "Labs", touchpoint: "Genome & Standard Tests", channel: "Lab", entity: "Labs + Malaffi", enhancement: "Unified sample collection" },
              { stage: "Results", touchpoint: "Receive status", channel: "TAMM Notification", entity: "DoH", enhancement: "Simple 'Valid/Invalid' status" },
              { stage: "ADJD Flag", touchpoint: "Sync with Justice", channel: "Backend", entity: "DoH -> ADJD", enhancement: "No medical data shared" }
            ]
          },
          marriage: {
            title: "Marriage Contract",
            subtitle: "Legal & Religious",
            icon: "Users",
            description: "Apply for your marriage contract digitally. We've pre-filled your details.",
            status: "In Progress",
            steps: [
              { title: "Application", desc: "Start your marriage file with ADJD.", status: "completed" },
              { title: "Eligibility Check", desc: "We verify your premarital screening status.", status: "completed" },
              { title: "Book Ceremony", desc: "Choose a court or authorized officiant.", status: "current" },
              { title: "Digital Contract", desc: "Receive your official marriage contract instantly.", status: "upcoming" },
              isCitizen ? { title: "Family Update", desc: "Your Family Book updates automatically.", status: "upcoming" } : null
            ].filter(Boolean),
            details: [
              { stage: "Application", touchpoint: "Start Marriage File", channel: "TAMM Family Space", entity: "ADJD", enhancement: "Pre-filled from ICP" },
              { stage: "Review", touchpoint: "Select Track (Sharia/Civil)", channel: "TAMM Family Space", entity: "ADJD", enhancement: "Policy-based routing" },
              { stage: "Ceremony", touchpoint: "Book Officiant/Court", channel: "TAMM + SMS", entity: "ADJD", enhancement: "Live availability" },
              { stage: "Contract", touchpoint: "Issue Digital Contract", channel: "TAMM Wallet", entity: "ADJD", enhancement: "Instant digital copy" },
              { stage: "Civil Updates", touchpoint: "Update Family Book", channel: "Backend", entity: "ADJD -> ICP", enhancement: "Auto-trigger for citizens" }
            ]
          },
          preconception: {
            title: "Planning a Baby",
            subtitle: "Pre-conception Support",
            icon: "HeartPulse",
            description: "Optional health checks and support for starting a family.",
            status: "Future",
            steps: [
              { title: "Health Profile", desc: "Complete your baseline health check.", status: "upcoming" },
              { title: "Education", desc: "Access preparation guides.", status: "upcoming" },
              { title: "Clinical Consult", desc: "Book a pre-conception visit if needed.", status: "upcoming" },
              { title: "IVF Support", desc: "Eligibility and referral if applicable.", status: "upcoming" },
              { title: "Maternity Handoff", desc: "Seamless transition to pregnancy care.", status: "upcoming" }
            ],
            details: [
              { stage: "Readiness", touchpoint: "Health Risk Assessment", channel: "TAMM Sahatna", entity: "DoH", enhancement: "Risk-based recommendations" },
              { stage: "Consult", touchpoint: "Pre-conception Visit", channel: "Clinic", entity: "SEHA / Private", enhancement: "Integrated care plan" },
              { stage: "IVF Branch", touchpoint: "Fertility Referral", channel: "TAMM Sahatna", entity: "DoH -> IVF Centers", enhancement: "Digital referral tracking" },
              { stage: "Transition", touchpoint: "Auto-draft Maternity", channel: "Backend", entity: "DoH -> Malaffi", enhancement: "Seamless record continuity" }
            ]
          },
          maternity: {
            title: "Maternity Journey",
            subtitle: "Antenatal to Delivery",
            icon: "Stethoscope",
            description: "Track your pregnancy milestones, appointments, and care plan.",
            status: "In Progress",
            steps: [
              { title: "Confirm Pregnancy", desc: "Register your maternity file.", status: "completed" },
              { title: "Care Plan", desc: "View your 9-visit antenatal schedule.", status: "current" },
              { title: "Gender Reveal", desc: revealedGender ? `It's a ${revealedGender}!` : "Ultrasound results ready.", status: revealedGender ? "completed" : "current", actionLabel: revealedGender ? null : "Reveal Gender" },
              { title: "Pre-Capture IDs", desc: "Upload parent docs now to save time at birth.", status: "upcoming" },
              { title: "Birth Notification", desc: "Provider submits data.", status: "upcoming", systemNote: "Pre-filled from Malaffi" }
            ],
            details: [
              { stage: "Registration", touchpoint: "Confirm Pregnancy", channel: "TAMM Sahatna", entity: "DoH + Malaffi", enhancement: "Auto-draft from lab result" },
              { stage: "Care Plan", touchpoint: "9-Visit Schedule", channel: "TAMM Sahatna", entity: "DoH", enhancement: "Visual timeline" },
              { stage: "Admin Prep", touchpoint: "Pre-capture Parent IDs", channel: "TAMM Family Space", entity: "ICP + ADJD", enhancement: "Avoid delivery-day admin" },
              { stage: "Delivery", touchpoint: "Hospital Admission", channel: "Hospital", entity: "SEHA / Private", enhancement: "Fast check-in via EID" },
              { stage: "Handoff", touchpoint: "Provider Birth Notification", channel: "Provider Console", entity: "Hospital -> DoH", enhancement: "Pre-filled from Malaffi" }
            ]
          },
          birth: birthJourney,
          newborn: {
            title: "Newborn Care",
            subtitle: "Screening & Vaccination",
            icon: "ShieldCheck",
            description: "Essential health checks immediately after birth.",
            status: "Action Required",
            steps: [
              { title: "Newborn Screening", desc: "Hearing, Heart, and Metabolic checks.", status: "current" },
              { title: "Results", desc: "View results (reported to MOHAP).", status: "upcoming" },
              { title: "Referrals", desc: "ZHO or Medical Specialist trigger if flagged.", status: "upcoming", systemNote: "Auto-referral" },
              { title: "Insurance", desc: "Auto-enrollment on family policy.", status: "upcoming" }
            ],
            details: [
              { stage: "Screening", touchpoint: "Metabolic/Hearing/CCHD", channel: "Hospital", entity: "DoH + Malaffi", enhancement: "Result to MOHAP" },
              { stage: "Referral", touchpoint: "ZHO/Specialist Trigger", channel: "TAMM Sahatna", entity: "DoH -> ZHO", enhancement: "Auto-referral on flag" },
              { stage: "Vaccination", touchpoint: "Schedule & Administer", channel: "Clinic", entity: "DoH", enhancement: "ADEK readiness signal" },
              { stage: "Education", touchpoint: "School Profile", channel: "TAMM Family Space", entity: "ADEK/MoE", enhancement: "Early seat reservation" }
            ]
          },
          vaccination: { 
            title: "Vaccinations", 
            subtitle: "Milestones", 
            icon: "HeartPulse", 
            description: "Immunization schedule.", 
            status: "Future",
            steps: [{title: "Schedule", status: "upcoming"}, {title: "Book", status: "upcoming"}, {title: "Record", status: "upcoming"}],
            details: [{stage: "Care", touchpoint: "Vaccine Admin", channel: "Clinic", entity: "DoH", enhancement: "Digital Registry"}]
          },
          education: { title: "Education", subtitle: "School Planning", icon: "GraduationCap", description: "Profile & Seats.", steps: [{title: "Profile", status: "upcoming"}, {title: "Seat", status: "upcoming"}], status: "Future", details: [] },
          adult: { title: "Adult Care", subtitle: "Prevention", icon: "Activity", description: "Wellness checks.", steps: [{title: "Checkup", status: "upcoming"}], status: "Future", details: [] },
          elderly: { title: "Elderly Care", subtitle: "Support", icon: "Users", description: "Home care & support.", steps: [{title: "Assessment", status: "upcoming"}], status: "Future", details: [] },
          sanadkom: { 
            title: "Sanadkom", 
            subtitle: "End of Life", 
            icon: "HandHeart", 
            description: "Bereavement support.", 
            status: "Future",
            steps: [{title: "Notification", status: "upcoming"}, {title: "Certificate", status: "upcoming"}, {title: "Benefits", status: "upcoming"}],
            details: [
              { stage: "Notification", touchpoint: "Provider Reports Death", channel: "Provider Console", entity: "Hospital", enhancement: "Clinical fact capture" },
              { stage: "Certificate", touchpoint: "Issue Death Certificate", channel: "TAMM Family Space", entity: "DoH", enhancement: "Digital issuance" },
              { stage: "Benefits", touchpoint: "Launch Sanadkom", channel: "TAMM Family Space", entity: "Sanadkom/DCD", enhancement: "Proactive support" },
              { stage: "Permits", touchpoint: "Burial/Transport", channel: "TAMM Family Space", entity: "Municipalities", enhancement: "Unified permit flow" }
            ]
          },
          housing: {
            title: "Housing & Support",
            subtitle: "ISKAN & Benefits",
            icon: "Home",
            description: "Apply for housing grants and social allowances.",
            status: "In Progress",
            steps: [
              { title: "Eligibility Check", desc: "Check if you qualify.", status: "completed" },
              { title: "Application", desc: "Submit your request.", status: "current" },
              { title: "Committee Review", desc: "Wait for decision.", status: "upcoming" }
            ],
            details: [
              { stage: "Check", touchpoint: "Eligibility Check", channel: "TAMM", entity: "ISKAN", enhancement: "Auto-check" },
              { stage: "Apply", touchpoint: "Submit Application", channel: "TAMM", entity: "ISKAN", enhancement: "Zero docs" },
              { stage: "Review", touchpoint: "Committee Review", channel: "Backend", entity: "ISKAN", enhancement: "Fast track" }
            ]
          },
          work: {
            title: "Work & Leave",
            subtitle: "Employment Support",
            icon: "Briefcase",
            description: "Manage maternity/paternity leave and return to work.",
            status: "Future",
            steps: [
              { title: "Employer Sync", desc: "Link employment record.", status: "upcoming" },
              { title: "Leave Request", desc: "Apply for leave.", status: "upcoming" },
              { title: "Return to Work", desc: "Confirm return date.", status: "upcoming" }
            ],
            details: [
              { stage: "Sync", touchpoint: "Employer Sync", channel: "TAMM", entity: "MOHRE", enhancement: "Auto-detect" },
              { stage: "Leave", touchpoint: "Leave Request", channel: "TAMM", entity: "Employer/MOHRE", enhancement: "Digital letter" }
            ]
          }
        };
      };

      // --- COMPONENTS ---

      function BabyNamingModal({ isOpen, onClose, onNameSubmit, persona }) {
        const [firstNameEn, setFirstNameEn] = useState("");
        const [firstNameAr, setFirstNameAr] = useState("");
        const [isSubmitting, setIsSubmitting] = useState(false);
        
        // AI Naming State
        const [aiPrompt, setAiPrompt] = useState("");
        const [aiSuggestions, setAiSuggestions] = useState([]);
        const [isGenerating, setIsGenerating] = useState(false);

        if (!isOpen) return null;

        const handleSubmit = () => {
          setIsSubmitting(true);
          setTimeout(() => {
            setIsSubmitting(false);
            onNameSubmit(firstNameEn);
            onClose();
          }, 1500);
        };

        const handleAiGenerate = () => {
          if (!aiPrompt) return;
          setIsGenerating(true);
          setAiSuggestions([]);
          
          setTimeout(() => {
            setIsGenerating(false);
            // Simulate suggestions based on prompt
            let results = ["Zayed", "Rashid", "Khalifa"];
            if (aiPrompt.toLowerCase().includes("r")) results = ["Rashed", "Reem", "Rawda"];
            if (aiPrompt.toLowerCase().includes("girl")) results = ["Latifa", "Shamsa", "Fatima"];
            if (aiPrompt.toLowerCase().includes("modern")) results = ["Ayla", "Zain", "Kayan"];
            
            setAiSuggestions(results);
          }, 1500);
        };

        const selectSuggestion = (name) => {
            setFirstNameEn(name);
            setFirstNameAr("..."); // Simulator simplified
        };

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
            <div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl animate-in fade-in zoom-in duration-200 overflow-hidden">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-bold text-slate-900">Name Your Baby</h3>
                <button onClick={onClose}><Icons.X className="h-5 w-5 text-slate-400" /></button>
              </div>
              
              <div className="space-y-4">
                {/* AI Assistant Section */}
                <div className="bg-purple-50 p-4 rounded-xl border border-purple-100 mb-4">
                    <div className="flex items-center gap-2 mb-2">
                        <Icons.Sparkles className="h-4 w-4 text-purple-600" />
                        <h4 className="text-sm font-bold text-purple-900">Need inspiration? Ask AI</h4>
                    </div>
                    <div className="flex gap-2">
                        <Input 
                            value={aiPrompt}
                            onChange={(e) => setAiPrompt(e.target.value)}
                            placeholder="e.g. Traditional names starting with R"
                            className="bg-white border-purple-200 focus:ring-purple-500 h-9 text-xs"
                        />
                        <Button 
                            variant="purple" 
                            size="sm" 
                            className="h-9 px-3"
                            onClick={handleAiGenerate}
                            disabled={!aiPrompt || isGenerating}
                        >
                            {isGenerating ? <Icons.Loader2 className="h-3 w-3 animate-spin" /> : <Icons.Wand2 className="h-3 w-3" />}
                        </Button>
                    </div>
                    
                    {aiSuggestions.length > 0 && (
                        <div className="mt-3 flex flex-wrap gap-2 animate-in slide-in-from-top-2">
                            {aiSuggestions.map(name => (
                                <button 
                                    key={name}
                                    onClick={() => selectSuggestion(name)}
                                    className="bg-white border border-purple-200 text-purple-700 px-3 py-1 rounded-full text-xs font-medium hover:bg-purple-100 transition-colors"
                                >
                                    {name}
                                </button>
                            ))}
                        </div>
                    )}
                </div>

                <div className="bg-blue-50 p-3 rounded-lg flex items-start gap-2">
                  <Icons.Info className="h-5 w-5 text-blue-600 mt-0.5" />
                  <p className="text-xs text-blue-800">
                    We will check your chosen name against {persona === 'citizen' ? 'ICP' : 'Official'} naming rules.
                  </p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">First Name (English)</label>
                  <Input value={firstNameEn} onChange={(e) => setFirstNameEn(e.target.value)} placeholder="e.g. Zayed" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">First Name (Arabic)</label>
                  <Input value={firstNameAr} onChange={(e) => setFirstNameAr(e.target.value)} placeholder="e.g. زايد" className="text-right" />
                </div>
                <div className="pt-2">
                  <div className="text-xs text-slate-500 mb-1">Family Name (Fixed)</div>
                  <div className="font-semibold text-slate-900 bg-slate-100 px-3 py-2 rounded-lg">{persona === 'citizen' ? 'Al Nuaimi' : 'Khan'}</div>
                </div>
                <Button onClick={handleSubmit} className="w-full mt-2" disabled={!firstNameEn || !firstNameAr || isSubmitting}>
                  {isSubmitting ? (<span className="flex items-center gap-2"><Icons.Loader2 className="h-4 w-4 animate-spin" /> Checking Rules...</span>) : "Confirm Name"}
                </Button>
              </div>
            </div>
          </div>
        );
      }

      function GenderRevealModal({ isOpen, onClose, onReveal }) {
        const [isRevealed, setIsRevealed] = useState(false);
        const [gender, setGender] = useState(null); // 'Boy' or 'Girl'
        const [showSurpriseForm, setShowSurpriseForm] = useState(false);
        const [contactName, setContactName] = useState("");
        const [contactInfo, setContactInfo] = useState("");
        const [isSending, setIsSending] = useState(false);
        const [isSent, setIsSent] = useState(false);

        useEffect(() => {
           if (isOpen && !isRevealed && !isSent) {
               // Simulate determining gender (for demo, we'll pick Boy)
               setGender("Boy");
               setShowSurpriseForm(false); // Reset form state
           }
        }, [isOpen, isRevealed, isSent]);

        const handleReveal = () => {
            setIsRevealed(true);
            setTimeout(() => {
                onReveal(gender);
            }, 500); 
        };

        const handleSurpriseClick = () => {
            setShowSurpriseForm(true);
        };

        const handleSendSurprise = () => {
            setIsSending(true);
            setTimeout(() => {
                setIsSending(false);
                setIsSent(true);
            }, 1500);
        };

        const handleClose = () => {
            onClose();
            // Reset for next time
            setTimeout(() => {
                setIsRevealed(false);
                setShowSurpriseForm(false);
                setIsSent(false);
            }, 500);
        };
        
        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-md">
            <div className="bg-white rounded-3xl w-full max-w-sm p-0 shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300 relative">
              <button onClick={handleClose} className="absolute top-4 right-4 z-10 p-2 bg-white/20 rounded-full hover:bg-white/40 transition-colors">
                  <Icons.X className={`h-6 w-6 ${isRevealed ? 'text-white' : 'text-slate-400'}`} />
              </button>

              {!isRevealed && !showSurpriseForm && (
                <div className="p-8 text-center space-y-6">
                    <div className="mx-auto w-24 h-24 bg-teal-50 rounded-full flex items-center justify-center mb-4">
                        <Icons.Gift className="h-12 w-12 text-teal-600" />
                    </div>
                    <div>
                        <h3 className="text-2xl font-bold text-slate-900 mb-2">Ready to see?</h3>
                        <p className="text-slate-500 text-sm">
                            The ultrasound results are in. You can reveal the gender now, or keep it a surprise for a special moment.
                        </p>
                    </div>
                    <div className="space-y-3">
                        <Button onClick={handleReveal} className="w-full h-12 text-base shadow-lg shadow-teal-500/20">
                            Reveal Gender
                        </Button>
                        <Button onClick={handleSurpriseClick} variant="ghost" className="w-full">
                            Keep it a Surprise
                        </Button>
                    </div>
                    <div className="flex items-center justify-center gap-2 text-xs text-slate-400">
                        <Icons.ShieldCheck className="h-3 w-3" /> Secure & Private
                    </div>
                </div>
              )}

              {!isRevealed && showSurpriseForm && !isSent && (
                  <div className="p-8 space-y-4">
                      <div className="flex items-center gap-2 mb-2">
                        <button onClick={() => setShowSurpriseForm(false)} className="p-1 -ml-2 rounded-full hover:bg-slate-100"><Icons.ArrowLeft className="h-5 w-5 text-slate-500"/></button>
                        <h3 className="text-xl font-bold text-slate-900">Surprise a Loved One</h3>
                      </div>
                      <p className="text-sm text-slate-500">
                          We will send a secure, locked digital envelope to your trusted contact. Only they can unlock the gender result.
                      </p>
                      <div>
                          <label className="block text-sm font-medium text-slate-700 mb-1">Contact Name</label>
                          <Input value={contactName} onChange={(e) => setContactName(e.target.value)} placeholder="e.g. My Sister" />
                      </div>
                      <div>
                          <label className="block text-sm font-medium text-slate-700 mb-1">Email or Phone</label>
                          <Input value={contactInfo} onChange={(e) => setContactInfo(e.target.value)} placeholder="e.g. 050xxxxxxx" />
                      </div>
                      <Button onClick={handleSendSurprise} className="w-full mt-2" disabled={!contactName || !contactInfo || isSending}>
                          {isSending ? (<span className="flex items-center gap-2"><Icons.Loader2 className="h-4 w-4 animate-spin" /> Sending...</span>) : `Send to ${contactName || 'Contact'}`}
                      </Button>
                  </div>
              )}

              {!isRevealed && isSent && (
                  <div className="p-10 text-center space-y-6">
                       <div className="mx-auto w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mb-4">
                            <Icons.Mail className="h-10 w-10 text-green-600" />
                        </div>
                        <div>
                            <h3 className="text-xl font-bold text-slate-900">Sent Successfully!</h3>
                            <p className="text-slate-500 text-sm mt-2">
                                The results have been securely sent to <strong>{contactName}</strong>. They can now plan the reveal for you!
                            </p>
                        </div>
                        <Button onClick={handleClose} variant="outline" className="w-full">Close</Button>
                  </div>
              )}

              {isRevealed && (
                <div className={`p-10 text-center flex flex-col items-center justify-center min-h-[400px] transition-colors duration-1000 ${gender === 'Boy' ? 'bg-blue-500' : 'bg-pink-500'}`}>
                    <div className="animate-pop-in">
                        <div className="mx-auto w-32 h-32 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center mb-6 shadow-xl ring-4 ring-white/30">
                            <Icons.Baby className="h-16 w-16 text-white" />
                        </div>
                        <h2 className="text-4xl font-extrabold text-white mb-2 tracking-tight">It's a {gender}!</h2>
                        <p className="text-white/90 text-lg">Congratulations!</p>
                    </div>
                    <div className="mt-12 w-full">
                         <Button onClick={handleClose} className="w-full bg-white text-slate-900 hover:bg-white/90 border-0 shadow-xl">
                            Start Planning
                         </Button>
                    </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      function JourneyTimeline({ data, onAction }) {
        if (!data || !data.steps || !data.steps.length) return <div className="text-sm text-slate-400 italic p-4">Timeline available upon activation.</div>;

        return (
          <div className="mt-6 relative pl-4 border-l-2 border-slate-100 space-y-8">
            {data.steps.map((step, i) => {
              const isCompleted = step.status === 'completed';
              const isCurrent = step.status === 'current';
              const hasAction = step.actionLabel && isCurrent;
              
              return (
                <div key={i} className="relative pl-6">
                  <div className={`absolute -left-[21px] top-1 w-4 h-4 rounded-full border-2 
                    ${isCompleted ? 'bg-teal-600 border-teal-600' : isCurrent ? 'bg-white border-teal-600 ring-4 ring-teal-50' : 'bg-slate-100 border-slate-300'}
                  `}>
                    {isCompleted && <Icons.CheckCircle2 className="w-3 h-3 text-white absolute top-[-1px] left-[-1px]" />}
                  </div>
                  
                  <div className={`flex flex-col ${isCurrent ? 'opacity-100' : 'opacity-70'}`}>
                    <div className="flex items-center justify-between">
                      <span className={`text-sm font-bold ${isCurrent ? 'text-teal-800' : 'text-slate-900'}`}>{step.title}</span>
                      {step.systemNote && <Badge variant="secondary" className="text-[10px] h-5 bg-slate-100 text-slate-500 font-normal ml-2">{step.systemNote}</Badge>}
                    </div>
                    <span className="text-xs text-slate-500 mt-0.5">{step.desc}</span>
                    
                    {hasAction && (
                      <div className="mt-3">
                        <Button 
                          size="sm" 
                          className={`h-8 text-xs rounded-lg ${step.title.includes('Gender') ? 'bg-indigo-600 hover:bg-indigo-700' : ''}`}
                          onClick={() => onAction && onAction(step.actionLabel)}
                        >
                          {step.actionLabel} 
                          {step.title.includes('Gender') ? <Icons.Eye className="ml-1.5 h-3 w-3" /> : <Icons.Pencil className="ml-1.5 h-3 w-3" />}
                        </Button>
                      </div>
                    )}
                    {isCurrent && !hasAction && (
                      <div className="mt-3">
                         <Badge variant="amber" className="font-normal">In Progress</Badge>
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        );
      }

      function JourneyMasterTable({ data }) {
        if (!data || !data.details || !data.details.length) return <div className="text-sm text-slate-400 italic p-4">Detailed plan available for active journeys.</div>;
        
        return (
          <div className="mt-4 overflow-x-auto pb-4">
            <table className="w-full text-sm text-left border-collapse min-w-[600px]">
              <thead>
                <tr className="border-b border-slate-100">
                  <th className="py-2 px-4 font-semibold text-slate-500 w-[120px]">Stage</th>
                  {data.details.map((s, i) => (
                    <th key={i} className="py-2 px-4 font-medium text-slate-900 bg-slate-50/50 border-r border-slate-100 min-w-[160px]">
                      {s.stage}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                <tr className="border-b border-slate-50">
                  <td className="py-3 px-4 font-medium text-slate-500">Touchpoint</td>
                  {data.details.map((s, i) => (
                    <td key={i} className="py-3 px-4 border-r border-slate-50 align-top">
                      <div className="font-semibold text-teal-800">{s.touchpoint}</div>
                    </td>
                  ))}
                </tr>
                <tr className="border-b border-slate-50 bg-slate-50/30">
                  <td className="py-3 px-4 font-medium text-slate-500">Channel</td>
                  {data.details.map((s, i) => (
                    <td key={i} className="py-3 px-4 border-r border-slate-50 align-top text-slate-600">
                      {s.channel}
                    </td>
                  ))}
                </tr>
                <tr className="border-b border-slate-50">
                  <td className="py-3 px-4 font-medium text-slate-500">Entity</td>
                  {data.details.map((s, i) => (
                    <td key={i} className="py-3 px-4 border-r border-slate-50 align-top text-slate-600">
                      <div className="flex items-center gap-1.5">
                        <Icons.Building2 className="h-3 w-3 text-slate-400" />
                        {s.entity}
                      </div>
                    </td>
                  ))}
                </tr>
              </tbody>
            </table>
          </div>
        );
      }

      function JourneyProgressCard({ journeyKey, data }) {
        const completedSteps = data.steps.filter(s => s.status === 'completed').length;
        const totalSteps = data.steps.length;
        const progressPercent = totalSteps > 0 ? (completedSteps / totalSteps) * 100 : 0;
        const Icon = Icons[data.icon] || Icons.Circle;

        return (
          <Card className="bg-white border-slate-200 overflow-hidden">
            <div className="p-6">
              <div className="flex items-start gap-4 mb-6">
                <div className="h-14 w-14 rounded-2xl bg-teal-50 text-teal-700 flex items-center justify-center shrink-0">
                  <Icon className="h-7 w-7" />
                </div>
                <div>
                  <div className="flex items-center gap-2 mb-1">
                    <h2 className="text-xl font-bold text-slate-900">{data.title}</h2>
                    <Badge variant={data.status === 'Completed' ? 'success' : 'amber'}>{data.status}</Badge>
                  </div>
                  <p className="text-slate-500 text-sm leading-relaxed">{data.description}</p>
                </div>
              </div>

              <div className="space-y-2">
                <div className="flex items-center justify-between text-xs font-medium text-slate-700">
                  <span>Journey Progress</span>
                  <span>{Math.round(progressPercent)}% ({completedSteps}/{totalSteps} steps)</span>
                </div>
                <Progress value={progressPercent} />
              </div>
            </div>
          </Card>
        );
      }

      function InteractiveAIAssistant({ persona }) {
        const [messages, setMessages] = useState([
          { role: 'ai', text: `Welcome back. I can help you prepare for your upcoming Life Events.` }
        ]);
        const [input, setInput] = useState("");
        const [isTyping, setIsTyping] = useState(false);
        const scrollRef = useRef(null);

        useEffect(() => {
          if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
        }, [messages, isTyping]);

        const handleSend = (text) => {
          const userText = text || input;
          if (!userText.trim()) return;

          setMessages(prev => [...prev, { role: 'user', text: userText }]);
          setInput("");
          setIsTyping(true);

          setTimeout(() => {
            let reply = "I can certainly help with that.";
            const lowerText = userText.toLowerCase();

            if (lowerText.includes('eligibility')) {
              reply = "I've checked your profile. You are eligible for the Premarital Screening. Would you like to book an appointment?";
            } else if (lowerText.includes('book')) {
              reply = "I can show you the nearest SEHA facilities. Please select 'Booking' in the journey card.";
            } else if (lowerText.includes('mabrouk') || lowerText.includes('birth certificate')) {
              if (persona === 'citizen') {
                reply = "As a Citizen, your Birth Certificate is part of the 'Mabrouk Ma Yak' bundle. Once the hospital notification is received, we'll issue the Certificate, EID, and Passport automatically.";
              } else {
                reply = "For Residents, you'll first issue the Birth Certificate. Then I can guide you through MOFA Attestation and the Embassy Passport application.";
              }
            } else if (lowerText.includes('apply')) {
                if (lowerText.includes('housing')) {
                    if (persona === 'citizen') {
                        reply = "I've checked your Family Book status. You are eligible for Housing Assistance. I have auto-submitted your application. Reference: HSG-9921.";
                    } else {
                        reply = "Housing assistance via ISKAN is currently available for UAE Citizens. Please check the 'Work & Leave' section for employer support.";
                    }
                } else if (lowerText.includes('leave')) {
                    reply = "I have connected with your employer. Your Paternity Leave request for 5 days has been drafted. Status: Pending Employer Action.";
                } else {
                    reply = "I can help you apply for Housing or Leave. Which one would you like?";
                }
            } else if (lowerText.includes('doc')) {
               reply = "Your verified Family Book is in the wallet below. Future documents like the Birth Certificate will appear there automatically.";
            }
            setMessages(prev => [...prev, { role: 'ai', text: reply }]);
            setIsTyping(false);
          }, 1200);
        };

        return (
          <Card className="flex flex-col h-[420px] shadow-lg border-0 bg-slate-900 text-white overflow-hidden">
            <div className="p-4 border-b border-slate-700 bg-slate-800/50 flex items-center gap-2">
              <div className="h-8 w-8 rounded-full bg-teal-500 flex items-center justify-center shadow-lg shadow-teal-500/20">
                <Icons.Sparkles className="h-4 w-4 text-white" />
              </div>
              <div>
                <h3 className="text-sm font-bold">Medical Assistant</h3>
                <p className="text-xs text-slate-400">Context-Aware Support</p>
              </div>
            </div>
            
            <div className="flex-1 overflow-y-auto p-4 space-y-4" ref={scrollRef}>
              {messages.map((m, i) => (
                <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'} animate-slide-up`}>
                  <div className={`max-w-[85%] rounded-2xl px-4 py-2.5 text-sm leading-relaxed ${
                    m.role === 'user' 
                      ? 'bg-teal-600 text-white rounded-tr-sm' 
                      : 'bg-slate-800 text-slate-200 rounded-tl-sm'
                  }`}>
                    {m.text}
                  </div>
                </div>
              ))}
              {isTyping && (
                <div className="flex justify-start animate-slide-up">
                  <div className="bg-slate-800 rounded-2xl rounded-tl-sm px-4 py-3">
                    <div className="flex gap-1">
                      <span className="w-1.5 h-1.5 bg-slate-500 rounded-full animate-bounce"></span>
                      <span className="w-1.5 h-1.5 bg-slate-500 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></span>
                      <span className="w-1.5 h-1.5 bg-slate-500 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></span>
                    </div>
                  </div>
                </div>
              )}
            </div>

            <div className="p-3 bg-slate-800/50 space-y-3">
              <div className="flex gap-2 overflow-x-auto hide-scrollbar pb-1">
                {persona === 'citizen' && (
                  <button onClick={() => handleSend("Apply for Housing")} className="whitespace-nowrap px-3 py-1.5 rounded-full bg-slate-700 hover:bg-slate-600 text-xs font-medium transition-colors">Apply Housing</button>
                )}
                <button onClick={() => handleSend("Request Leave")} className="whitespace-nowrap px-3 py-1.5 rounded-full bg-slate-700 hover:bg-slate-600 text-xs font-medium transition-colors">Request Leave</button>
                <button onClick={() => handleSend("Check eligibility")} className="whitespace-nowrap px-3 py-1.5 rounded-full bg-slate-700 hover:bg-slate-600 text-xs font-medium transition-colors">Eligibility</button>
                {persona === 'citizen' && (
                  <button onClick={() => handleSend("How does Mabrouk Ma Yak work?")} className="whitespace-nowrap px-3 py-1.5 rounded-full bg-slate-700 hover:bg-slate-600 text-xs font-medium transition-colors">Mabrouk Ma Yak info</button>
                )}
              </div>
              <div className="flex gap-2">
                <input 
                  className="flex-1 bg-slate-950/50 border border-slate-700 rounded-xl px-4 text-sm text-white placeholder:text-slate-500 focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 transition-all"
                  placeholder="Ask anything..."
                  value={input}
                  onChange={e => setInput(e.target.value)}
                  onKeyDown={e => e.key === 'Enter' && handleSend()}
                />
                <button onClick={() => handleSend()} className="h-10 w-10 rounded-xl bg-teal-600 hover:bg-teal-500 flex items-center justify-center transition-colors">
                  <Icons.Send className="h-4 w-4" />
                </button>
              </div>
            </div>
          </Card>
        );
      }

      function LifeEventsMedicalHubDashboard() {
        const [personaKey, setPersonaKey] = useState("citizen");
        const [activeJourneyKey, setActiveJourneyKey] = useState("maternity"); // Default to maternity to see feature
        const [viewMode, setViewMode] = useState("timeline"); // "timeline" or "table"
        
        // --- STATES ---
        const [babyName, setBabyName] = useState(null);
        const [revealedGender, setRevealedGender] = useState(null);
        
        // --- CUSTOMIZE JOURNEY ---
        const [visibleJourneyIds, setVisibleJourneyIds] = useState([
            "premarital", "marriage", "preconception", "maternity", "birth",
            "newborn", "vaccination", "education", "adult", "elderly", "sanadkom"
        ]);
        const [isCustomizeOpen, setIsCustomizeOpen] = useState(false);

        const [isNamingModalOpen, setIsNamingModalOpen] = useState(false);
        const [isRevealModalOpen, setIsRevealModalOpen] = useState(false);

        const personas = getPersonas(babyName, revealedGender);
        const activePersona = personas[personaKey];
        // Pass babyName & gender to data factory
        const JOURNEY_DATA = useMemo(() => getJourneyData(personaKey, babyName, revealedGender), [personaKey, babyName, revealedGender]);

        // Handler defined clearly in scope
        const handleJourneyClick = (key) => {
          setActiveJourneyKey(key);
        };

        const handleTimelineAction = (actionLabel) => {
          if (actionLabel === "Start Naming" || actionLabel === "Issue Certificate") {
            setIsNamingModalOpen(true);
          }
          if (actionLabel === "Reveal Gender") {
            setIsRevealModalOpen(true);
          }
        };

        const handleNameSubmit = (name) => {
          setBabyName(name);
        };

        const handleGenderReveal = (gender) => {
          setRevealedGender(gender);
        };
        
        const toggleJourneyVisibility = (id) => {
            setVisibleJourneyIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
        };

        // Navigation Spine Items (Base)
        const ALL_LIFE_SPINE = [
          { id: "premarital", label: "Premarital" },
          { id: "marriage", label: "Marriage" },
          { id: "preconception", label: "Pre-conception" },
          { id: "maternity", label: "Maternity" },
          { id: "birth", label: personaKey === 'citizen' ? "Mabrouk Ma Yak" : "Birth & Residency" },
          { id: "newborn", label: "Newborn Care" },
          { id: "vaccination", label: "Vaccination" },
          { id: "education", label: "Education" },
          { id: "adult", label: "Adult Care" },
          { id: "elderly", label: "Elderly Care" },
          { id: "sanadkom", label: "End of Life" }
        ];
        
        // Filtered Spine
        const VISIBLE_SPINE = ALL_LIFE_SPINE.filter(s => visibleJourneyIds.includes(s.id));

        return (
          <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-900 pb-20">
            <div className="max-w-7xl mx-auto space-y-6">
              
              {/* Header */}
              <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div className="flex items-center gap-3">
                  <div className="h-12 w-12 rounded-2xl bg-teal-700 text-white flex items-center justify-center shadow-sm">
                    <Icons.Activity className="h-6 w-6" />
                  </div>
                  <div>
                    <div className="text-xs font-bold text-slate-500 uppercase tracking-wide">TAMM | Sahatna & Family Space</div>
                    <h1 className="text-2xl font-bold text-slate-900">Life Events Medical Hub</h1>
                  </div>
                </div>
                <div className="bg-white rounded-xl border border-slate-200 p-1 flex items-center shadow-sm">
                  <button 
                    onClick={() => { setPersonaKey("citizen"); setBabyName(null); setRevealedGender(null); }}
                    className={`px-4 py-1.5 rounded-lg text-sm font-medium transition-all ${personaKey === 'citizen' ? 'bg-slate-900 text-white shadow' : 'text-slate-500 hover:bg-slate-50'}`}
                  >
                    Citizen
                  </button>
                  <button 
                    onClick={() => { setPersonaKey("resident"); setBabyName(null); setRevealedGender(null); }}
                    className={`px-4 py-1.5 rounded-lg text-sm font-medium transition-all ${personaKey === 'resident' ? 'bg-slate-900 text-white shadow' : 'text-slate-500 hover:bg-slate-50'}`}
                  >
                    Resident
                  </button>
                </div>
              </div>

              {/* Family Context Card */}
              <Card className="bg-white">
                <CardContent className="p-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                  <div className="flex items-center gap-4">
                    <div className={`h-14 w-14 rounded-full flex items-center justify-center border-2 border-white shadow-sm transition-colors ${revealedGender ? (revealedGender === 'Boy' ? 'bg-blue-100 text-blue-600' : 'bg-pink-100 text-pink-600') : 'bg-slate-100 text-slate-400'}`}>
                      {revealedGender ? <Icons.Baby className="h-7 w-7" /> : <Icons.User className="h-7 w-7" />}
                    </div>
                    <div>
                      <h2 className="text-xl font-bold text-slate-900">{activePersona.familyName}</h2>
                      <div className="text-sm text-slate-500 flex items-center gap-2 mt-1">
                        <span>{activePersona.parents}</span>
                        <span className="w-1 h-1 rounded-full bg-slate-300"></span>
                        <span className={`flex items-center gap-1 font-medium ${revealedGender ? (revealedGender === 'Boy' ? 'text-blue-700' : 'text-pink-700') : 'text-teal-700'}`}>
                          <Icons.Baby className="h-3 w-3" /> {babyName ? `Named: ${babyName}` : activePersona.expectedBaby}
                        </span>
                        <span className="w-1 h-1 rounded-full bg-slate-300"></span>
                        <span className="flex items-center gap-1"><Icons.MapPin className="h-3 w-3" /> {activePersona.location}</span>
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Life Spine Rail with Customize Button */}
              <div className="relative">
                  <div className="flex justify-end mb-2">
                     <button onClick={() => setIsCustomizeOpen(!isCustomizeOpen)} className="text-xs font-medium text-teal-700 hover:text-teal-800 flex items-center gap-1">
                        <Icons.Settings2 className="h-3.5 w-3.5" /> Customize Journey
                     </button>
                     {isCustomizeOpen && (
                        <div className="absolute top-8 right-0 z-20 w-64 bg-white rounded-xl shadow-xl border border-slate-200 p-4 animate-in fade-in slide-in-from-top-2">
                            <h4 className="text-sm font-bold mb-3">Visible Stages</h4>
                            <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                                {ALL_LIFE_SPINE.map(s => (
                                    <label key={s.id} className="flex items-center gap-2 text-sm cursor-pointer hover:bg-slate-50 p-1 rounded">
                                        <div 
                                            className={`w-4 h-4 rounded border flex items-center justify-center ${visibleJourneyIds.includes(s.id) ? 'bg-teal-600 border-teal-600' : 'border-slate-300'}`}
                                            onClick={() => toggleJourneyVisibility(s.id)}
                                        >
                                            {visibleJourneyIds.includes(s.id) && <Icons.CheckCircle2 className="w-3 h-3 text-white" />}
                                        </div>
                                        <span>{s.label}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                     )}
                  </div>
                  <div className="overflow-x-auto pb-2 hide-scrollbar">
                    <div className="flex items-center gap-2 min-w-max">
                      {VISIBLE_SPINE.map((s, i) => (
                        <div key={s.id} className="flex items-center">
                          <button 
                            onClick={() => {
                              handleJourneyClick(s.id);
                              setViewMode('timeline'); // Reset to timeline on change
                            }}
                            className={`flex items-center gap-2 px-4 py-2 rounded-full border text-sm font-medium transition-all whitespace-nowrap
                              ${activeJourneyKey === s.id ? 'bg-teal-50 border-teal-200 text-teal-800 ring-2 ring-teal-500 ring-offset-2' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}
                            `}
                          >
                            <span className={`w-2 h-2 rounded-full ${activeJourneyKey === s.id ? 'bg-teal-500' : 'bg-slate-300'}`}></span>
                            {s.label}
                          </button>
                          {i < VISIBLE_SPINE.length - 1 && <div className="w-8 h-[1px] bg-slate-200"></div>}
                        </div>
                      ))}
                    </div>
                  </div>
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                
                {/* Left Col: Active Journey Detail */}
                <div className="lg:col-span-2 space-y-8">
                  
                  {/* Journey Progress Card (New Design) */}
                  <JourneyProgressCard journeyKey={activeJourneyKey} data={JOURNEY_DATA[activeJourneyKey]} />

                  {/* View Mode Toggle & Content */}
                  <div>
                    <div className="flex items-center justify-between mb-4">
                      <h3 className="font-bold text-lg text-slate-900 flex items-center gap-2">
                        {viewMode === 'timeline' ? <Icons.ListTodo className="h-5 w-5 text-teal-600" /> : <Icons.Table2 className="h-5 w-5 text-teal-600" />}
                        {viewMode === 'timeline' ? "Your Steps" : "Master Plan"}
                      </h3>
                      
                      <div className="bg-slate-100 p-1 rounded-lg flex gap-1">
                        <button 
                          onClick={() => setViewMode('timeline')}
                          className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all flex items-center gap-1.5 ${viewMode === 'timeline' ? 'bg-white shadow text-teal-700' : 'text-slate-500 hover:bg-slate-200'}`}
                        >
                          <Icons.ListTodo className="h-3.5 w-3.5" /> Your Steps
                        </button>
                        <button 
                          onClick={() => setViewMode('table')}
                          className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all flex items-center gap-1.5 ${viewMode === 'table' ? 'bg-white shadow text-teal-700' : 'text-slate-500 hover:bg-slate-200'}`}
                        >
                          <Icons.Table2 className="h-3.5 w-3.5" /> Master Plan
                        </button>
                      </div>
                    </div>

                    <Card className="bg-white overflow-hidden min-h-[300px]">
                      <div className="p-6">
                        {viewMode === 'timeline' ? (
                          <JourneyTimeline 
                            data={JOURNEY_DATA[activeJourneyKey]} 
                            onAction={handleTimelineAction}
                          />
                        ) : (
                          <JourneyMasterTable data={JOURNEY_DATA[activeJourneyKey]} />
                        )}
                      </div>
                    </Card>
                  </div>

                  {/* Parallel Support Lane */}
                  <div className="pt-8 border-t border-slate-200">
                    <h3 className="text-lg font-bold text-slate-900 mb-4">Parallel Support</h3>
                    <div className="grid md:grid-cols-2 gap-4">
                      <Card onClick={() => handleJourneyClick('housing')} className="bg-slate-50 border-dashed hover:border-slate-300 transition-colors cursor-pointer">
                        <CardContent className="p-4 flex items-center gap-3">
                          <div className="h-10 w-10 rounded-lg bg-white border border-slate-200 flex items-center justify-center"><Icons.Home className="h-5 w-5 text-slate-400" /></div>
                          <div>
                            <div className="font-semibold text-sm">Housing & Support</div>
                            <div className="text-xs text-slate-500">ISKAN eligibility check</div>
                          </div>
                        </CardContent>
                      </Card>
                      <Card onClick={() => handleJourneyClick('work')} className="bg-slate-50 border-dashed hover:border-slate-300 transition-colors cursor-pointer">
                        <CardContent className="p-4 flex items-center gap-3">
                          <div className="h-10 w-10 rounded-lg bg-white border border-slate-200 flex items-center justify-center"><Icons.Briefcase className="h-5 w-5 text-slate-400" /></div>
                          <div>
                            <div className="font-semibold text-sm">Work & Leave</div>
                            <div className="text-xs text-slate-500">MOHRE / Employer sync</div>
                          </div>
                        </CardContent>
                      </Card>
                    </div>
                  </div>

                </div>

                {/* Right Col: Assistant & Docs */}
                <div className="space-y-6">
                  
                  {/* Interactive AI Assistant */}
                  <InteractiveAIAssistant persona={personaKey} />

                  {/* Documents Shelf */}
                  <Card>
                    <CardHeader className="pb-3 border-b border-slate-100">
                      <CardTitle className="text-base flex items-center gap-2"><Icons.FileText className="h-4 w-4" /> Wallet & Docs</CardTitle>
                    </CardHeader>
                    <CardContent className="pt-4 space-y-3">
                      <div className="flex items-center justify-between text-sm">
                        <span className="flex items-center gap-2"><Icons.CheckCircle2 className="h-3 w-3 text-teal-600" /> Family Book</span>
                        <Badge variant="outline" className="text-[10px] h-5">Verified</Badge>
                      </div>
                      <div className="flex items-center justify-between text-sm">
                        <span className="flex items-center gap-2"><Icons.Clock className="h-3 w-3 text-amber-500" /> Birth Cert (Draft)</span>
                        <Badge variant="outline" className="text-[10px] h-5 bg-amber-50 text-amber-700 border-amber-200">Pending</Badge>
                      </div>
                      <div className="flex items-center justify-between text-sm">
                        <span className="flex items-center gap-2"><Icons.CheckCircle2 className="h-3 w-3 text-teal-600" /> Marriage Contract</span>
                        <Badge variant="outline" className="text-[10px] h-5">Verified</Badge>
                      </div>
                    </CardContent>
                  </Card>

                </div>
              </div>

              {/* MODALS */}
              <BabyNamingModal 
                isOpen={isNamingModalOpen} 
                onClose={() => setIsNamingModalOpen(false)}
                onNameSubmit={handleNameSubmit}
                persona={personaKey}
              />
              <GenderRevealModal
                isOpen={isRevealModalOpen}
                onClose={() => setIsRevealModalOpen(false)}
                onReveal={handleGenderReveal}
              />

            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<LifeEventsMedicalHubDashboard />);
    </script>
  </body>
</html>
